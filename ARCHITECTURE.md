# RAG 챗봇 시스템 - 개발 전략 및 상세 설계

## 📋 목차
1. [프로젝트 개요](#1-프로젝트-개요)
2. [시스템 아키텍처](#2-시스템-아키텍처)
3. [기술 스택](#3-기술-스택)
4. [모듈 설계](#4-모듈-설계)
5. [데이터 파이프라인](#5-데이터-파이프라인)
6. [검색 및 답변 전략](#6-검색-및-답변-전략)
7. [성능 최적화](#7-성능-최적화)
8. [확장성 고려사항](#8-확장성-고려사항)

---

## 1. 프로젝트 개요

### 1.1 목표
- 사내 1000개 Word 문서를 기반으로 한 지능형 Q&A 시스템 구축
- 텍스트 및 이미지(OCR) 모두를 의미 기반 검색으로 활용
- 사용자 친화적인 웹 인터페이스 제공

### 1.2 핵심 요구사항
✅ Word 문서 처리 (텍스트 + 이미지)
✅ OCR을 통한 이미지 내 텍스트 추출
✅ 벡터 기반 의미 검색
✅ LLM 기반 자연어 답변 생성
✅ Streamlit 웹 인터페이스
✅ 환경 변수 관리 (.env)

---

## 2. 시스템 아키텍처

### 2.1 전체 아키텍처

```
┌─────────────────────────────────────────────────────────────┐
│                     사용자 인터페이스                          │
│                  (Streamlit Web App)                         │
└────────────────────┬────────────────────────────────────────┘
                     │
                     │ 사용자 질의
                     ▼
┌─────────────────────────────────────────────────────────────┐
│                    RAG Engine Layer                          │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐      │
│  │   Query      │  │   Retrieval  │  │  Generation  │      │
│  │  Processing  │→ │   (Vector    │→ │   (GPT-4)    │      │
│  │              │  │   Search)    │  │              │      │
│  └──────────────┘  └──────────────┘  └──────────────┘      │
└────────────────────┬────────────────────────────────────────┘
                     │
                     │ 벡터 검색
                     ▼
┌─────────────────────────────────────────────────────────────┐
│                  Vector Database Layer                       │
│              (ChromaDB - Persistent Storage)                 │
│  ┌──────────────────────────────────────────────────────┐   │
│  │  Text Embeddings    │  OCR Embeddings  │  Metadata  │   │
│  │  (OpenAI API)       │  (OpenAI API)    │            │   │
│  └──────────────────────────────────────────────────────┘   │
└────────────────────┬────────────────────────────────────────┘
                     │
                     │ 인덱싱
                     ▼
┌─────────────────────────────────────────────────────────────┐
│               Document Processing Pipeline                   │
│  ┌───────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐  │
│  │  Word     │→ │  Text    │→ │  Chunk   │→ │ Embed &  │  │
│  │  Parser   │  │  Extract │  │  Split   │  │  Store   │  │
│  └───────────┘  └──────────┘  └──────────┘  └──────────┘  │
│  ┌───────────┐  ┌──────────┐  ┌──────────┐                 │
│  │  Image    │→ │   OCR    │→ │ Embed &  │                 │
│  │  Extract  │  │  (EasyOCR│  │  Store   │                 │
│  └───────────┘  └──────────┘  └──────────┘                 │
└─────────────────────────────────────────────────────────────┘
                     │
                     │ 원본 데이터
                     ▼
┌─────────────────────────────────────────────────────────────┐
│                   Data Storage Layer                         │
│  ┌────────────────────┐  ┌────────────────────┐            │
│  │  Word Documents    │  │  Extracted Images  │            │
│  │  (data/documents)  │  │  (data/images)     │            │
│  └────────────────────┘  └────────────────────┘            │
└─────────────────────────────────────────────────────────────┘
```

### 2.2 데이터 흐름

#### 인덱싱 단계
```
Word 문서 (.docx)
    │
    ├─→ [텍스트 추출] → 청킹 → 임베딩 → ChromaDB
    │
    └─→ [이미지 추출] → OCR → 임베딩 → ChromaDB
```

#### 검색 단계
```
사용자 질의
    │
    ├─→ [임베딩 생성] → ChromaDB 검색 → Top-K 문서
    │
    └─→ [컨텍스트 구성] → GPT-4 프롬프트 → 답변 생성
```

---

## 3. 기술 스택

### 3.1 핵심 기술

| 영역 | 기술 | 선택 이유 |
|------|------|-----------|
| **문서 처리** | python-docx | Word 문서 표준 라이브러리 |
| **이미지 처리** | Pillow | 경량 이미지 처리 |
| **OCR** | EasyOCR | 한글 지원 우수, 설치 간편 |
| **벡터 DB** | ChromaDB | 오픈소스, 로컬 저장 지원 |
| **임베딩** | OpenAI text-embedding-3-small | 고품질, 비용 효율적 |
| **LLM** | OpenAI GPT-4o-mini | 정확도와 속도 균형 |
| **웹 프레임워크** | Streamlit | 빠른 프로토타이핑, 사용 편의성 |
| **환경 관리** | python-dotenv | 표준 환경 변수 관리 |

### 3.2 대안 기술 검토

#### 벡터 DB 대안
- **Faiss**: 더 빠르지만 메타데이터 관리가 약함
- **Pinecone**: 클라우드 기반, 비용 발생
- **Weaviate**: 기능 풍부하지만 무거움
- ✅ **ChromaDB**: 오픈소스, 로컬 저장, 적절한 성능

#### OCR 대안
- **Tesseract**: 무료지만 한글 정확도 낮음
- **Google Vision API**: 높은 정확도지만 비용 발생
- ✅ **EasyOCR**: 한글 지원 우수, 무료

---

## 4. 모듈 설계

### 4.1 Document Processor (document_processor.py)

**책임**: Word 문서의 텍스트와 이미지 추출

**주요 메서드**:
```python
- extract_text_from_docx(file_path) -> str
  목적: 본문, 표의 텍스트 추출
  
- extract_images_from_docx(file_path, output_dir) -> List[str]
  목적: 문서 내 이미지 저장 및 경로 반환
  
- chunk_text(text) -> List[str]
  목적: 긴 텍스트를 검색 가능한 청크로 분할
  전략: 500자 단위, 100자 오버랩
  
- process_document(file_path) -> Dict
  목적: 전체 문서 처리 파이프라인
```

**청킹 전략**:
- 크기: 500자 (약 200-300 토큰)
- 오버랩: 100자 (문맥 유지)
- 경계: 문장 단위로 자르기 (마침표, 줄바꿈 기준)

### 4.2 OCR Processor (ocr_processor.py)

**책임**: 이미지에서 텍스트 추출

**주요 메서드**:
```python
- extract_text_from_image(image_path) -> str
  목적: 단일 이미지 OCR
  언어: 한글(ko), 영문(en)
  
- process_images_batch(image_paths) -> Dict[str, str]
  목적: 다중 이미지 배치 처리
  최적화: GPU 활용 가능
```

**OCR 파라미터**:
- 언어: ['ko', 'en']
- GPU: 선택적 (CUDA 필요)
- 신뢰도 임계값: 0.5 (필터링용)

### 4.3 Vector Store (vector_store.py)

**책임**: 벡터 데이터베이스 관리

**주요 메서드**:
```python
- get_embedding(text) -> List[float]
  목적: 텍스트 임베딩 생성
  모델: text-embedding-3-small (1536차원)
  
- add_documents(documents) -> None
  목적: 문서를 벡터 DB에 저장
  배치: 100개씩 처리
  
- search(query, n_results) -> Dict
  목적: 유사 문서 검색
  메트릭: 코사인 유사도
```

**벡터 DB 설정**:
- 컬렉션: rag_documents
- 유사도 메트릭: cosine
- 배치 크기: 100 (API 한도 고려)

### 4.4 RAG Engine (rag_engine.py)

**책임**: 검색 및 답변 생성

**주요 메서드**:
```python
- retrieve_relevant_documents(query, top_k) -> List[Dict]
  목적: 관련 문서 검색
  반환: 문서 + 메타데이터 + 유사도 점수
  
- generate_answer(query, context_documents) -> Dict
  목적: LLM 기반 답변 생성
  프롬프트: 시스템 + 컨텍스트 + 질의
  
- query(query) -> Dict
  목적: 전체 RAG 파이프라인 실행
```

**프롬프트 전략**:
```
시스템 프롬프트:
- 역할: 사내 지식문서 전문 AI
- 규칙: 문서 기반 답변, 출처 명시

사용자 프롬프트:
- 검색된 문서 컨텍스트 제공
- 명확한 질문 명시
```

### 4.5 Chatbot (chatbot.py)

**책임**: 전체 워크플로우 통합

**주요 메서드**:
```python
- index_documents(enable_ocr, gpu) -> Dict
  목적: 문서 인덱싱 파이프라인
  단계: 문서 처리 → OCR → 벡터화 → 저장
  
- chat(query, top_k) -> Dict
  목적: 사용자 질의 처리
  
- get_stats() -> Dict
  목적: 시스템 통계 반환
```

### 4.6 Streamlit App (app.py)

**책임**: 사용자 인터페이스

**주요 기능**:
- 채팅 인터페이스
- 문서 인덱싱 제어
- 시스템 통계 표시
- 설정 관리

---

## 5. 데이터 파이프라인

### 5.1 인덱싱 파이프라인

```
┌──────────────────────────────────────────────────────────┐
│ 1. 문서 스캔                                              │
│    - data/documents/*.docx 파일 찾기                      │
│    - 임시 파일 제외 (~$*.docx)                           │
└──────────────┬───────────────────────────────────────────┘
               │
               ▼
┌──────────────────────────────────────────────────────────┐
│ 2. 문서 처리                                              │
│    - 텍스트 추출 (본문 + 표)                             │
│    - 이미지 추출 및 저장                                  │
│    - 텍스트 청킹 (500자, 100자 오버랩)                   │
└──────────────┬───────────────────────────────────────────┘
               │
               ▼
┌──────────────────────────────────────────────────────────┐
│ 3. 텍스트 벡터화                                          │
│    - OpenAI API로 임베딩 생성                            │
│    - 배치 처리 (100개씩)                                 │
│    - ChromaDB에 저장                                     │
└──────────────┬───────────────────────────────────────────┘
               │
               ▼
┌──────────────────────────────────────────────────────────┐
│ 4. OCR 처리 (옵션)                                        │
│    - 이미지에서 텍스트 추출                               │
│    - 한글/영문 인식                                       │
│    - 임베딩 생성 및 저장                                  │
└──────────────┬───────────────────────────────────────────┘
               │
               ▼
┌──────────────────────────────────────────────────────────┐
│ 5. 완료 및 통계                                           │
│    - 처리된 문서 수                                       │
│    - 생성된 청크 수                                       │
│    - OCR 텍스트 수                                        │
└──────────────────────────────────────────────────────────┘
```

### 5.2 데이터 메타데이터

각 벡터 항목에 저장되는 메타데이터:

**텍스트 청크**:
```python
{
    'file_name': '문서명.docx',
    'file_path': '/full/path/to/document.docx',
    'chunk_index': 0,  # 청크 순서
    'type': 'text'
}
```

**OCR 텍스트**:
```python
{
    'file_name': '문서명 (이미지)',
    'image_path': '/path/to/image.png',
    'type': 'ocr'
}
```

---

## 6. 검색 및 답변 전략

### 6.1 검색 전략

**1단계: 쿼리 임베딩**
```
사용자 질의 → OpenAI Embedding API → 1536차원 벡터
```

**2단계: 유사도 검색**
```
쿼리 벡터 → ChromaDB 코사인 유사도 → Top-K 문서
```

**3단계: 결과 필터링**
- 유사도 임계값: 0.7 이상
- 중복 제거: 같은 문서의 중복 청크 제거
- 타입 균형: 텍스트와 OCR 혼합

### 6.2 답변 생성 전략

**컨텍스트 구성**:
```
[문서 1: 파일명]
문서 내용...

[문서 2: 파일명 (이미지 내용)]
OCR 텍스트...

...
```

**프롬프트 구조**:
```
시스템: 당신은 사내 지식문서 전문 AI입니다.
        제공된 문서만 참고하여 답변하세요.

사용자: [컨텍스트]
        
        질문: {사용자 질의}
```

**답변 후처리**:
- 출처 문서 목록 추가
- 유사도 점수 표시
- 하이퍼링크 (가능한 경우)

---

## 7. 성능 최적화

### 7.1 인덱싱 최적화

**배치 처리**:
- 임베딩 API 호출: 100개씩 배치
- ChromaDB 삽입: 100개씩 배치
- 예상 시간: 1000개 문서 → 30-60분

**병렬 처리** (향후 개선):
- 문서 처리: 멀티프로세싱
- OCR: GPU 활용

### 7.2 검색 최적화

**캐싱**:
- Streamlit 캐시: VectorStore 인스턴스
- 중복 쿼리 방지

**청킹 최적화**:
- 크기: 500자 (너무 크면 검색 부정확, 너무 작으면 문맥 손실)
- 오버랩: 100자 (문맥 유지)

### 7.3 비용 최적화

**API 호출 최소화**:
- 임베딩 캐싱
- 배치 처리
- 예상 비용: 1000개 문서 → 약 $2-5

---

## 8. 확장성 고려사항

### 8.1 수평 확장

**문서 수 증가**:
- 현재: 1000개
- 향후: 10,000개+
- 해결: ChromaDB 샤딩, 클라우드 벡터 DB (Pinecone)

### 8.2 기능 확장

**추가 가능 기능**:
- PDF 지원
- 이미지 설명 생성
- 다국어 지원
- 실시간 문서 업데이트
- 사용자 피드백 학습

### 8.3 배포 전략

**로컬 배포**:
- 현재 구조 그대로 사용

**클라우드 배포**:
- Docker 컨테이너화
- AWS/GCP/Azure 배포
- 벡터 DB: Pinecone/Weaviate로 마이그레이션

---

## 9. 보안 및 프라이버시

### 9.1 API 키 관리
- .env 파일 사용
- .gitignore에 추가
- 환경 변수로 관리

### 9.2 데이터 보안
- 로컬 저장 (외부 유출 방지)
- 문서 접근 제어 (향후)

---

## 10. 테스트 전략

### 10.1 단위 테스트
- 각 모듈별 독립 테스트
- pytest 프레임워크 사용

### 10.2 통합 테스트
- 전체 파이프라인 테스트
- 샘플 문서로 검증

### 10.3 성능 테스트
- 인덱싱 시간 측정
- 검색 응답 시간 측정
- 메모리 사용량 모니터링

---

## 요약

이 시스템은 다음과 같은 특징을 가집니다:

✅ **모듈화**: 각 컴포넌트가 독립적으로 동작
✅ **확장성**: 쉽게 기능 추가 가능
✅ **성능**: 배치 처리로 최적화
✅ **사용성**: Streamlit으로 직관적 인터페이스
✅ **유지보수성**: 명확한 코드 구조와 문서화

향후 개선 방향:
- 성능 모니터링 대시보드
- 사용자 피드백 시스템
- 자동 재인덱싱
- 다국어 지원
